# Алгоритм обработки запроса (GET /api/activate/:link):

## 1. Поступление запроса

Поступает GET запрос на `/api/activate/:link`, где `:link` - это параметр пути (path parameter), содержащий активационную ссылку.

**Пример запроса**: `GET /api/activate/550e8400-e29b-41d4-a716-446655440000`

**Требования**: 
- Запрос не требует аутентификации
- Запрос не требует тела (body)
- Активационная ссылка передается как параметр пути

## 2. Middleware обработка (до контроллера)

**Важно**: Данный endpoint не использует никаких middleware. Запрос напрямую передается в контроллер.

В отличие от других endpoints (login, registration, logout, refresh), activate не требует:
- Device Info Middleware
- Email Lowercase Middleware
- Валидации через express-validator
- Аутентификации через Access Token

Это позволяет активировать аккаунт без необходимости быть авторизованным пользователем.

## 3. Обработка в контроллере (`personController.activate`)

### 3.1. Извлечение активационной ссылки
- Извлекается параметр `link` из пути запроса: `req.params.link`
- Значение сохраняется в переменную `activationLink`
- Это UUID (v4), который был сгенерирован при регистрации пользователя и отправлен в email

### 3.2. Активация аккаунта (`personService.activate`)
- Выполняется поиск пользователя по активационной ссылке:
  - Используется `db.findPersonByLink(activationLink)`
  - Выполняется запрос в PostgreSQL для поиска пользователя с указанным `activation_link`
- **Проверка существования пользователя**:
  - Если пользователь с такой активационной ссылкой не найден:
    - Выбрасывается `ApiError.PersonLinkNotExistError()`
    - Возвращается ответ со статусом **404** и кодом ошибки **6** (`link_not_exist`)
    - Сообщение об ошибке: "Person activation link not exist"
- **Активация аккаунта** (если пользователь найден):
  - Устанавливается `person.is_activated = true`
  - Очищается `person.activation_link = ''` (пустая строка)
  - Это предотвращает повторное использование активационной ссылки
- **Обновление в БД**:
  - Выполняется обновление пользователя в PostgreSQL через `db.updatePerson(person)`
  - Обновляются поля `is_activated` и `activation_link` в таблице `auth.person`

### 3.3. Формирование ответа
- Возвращается ответ со статусом **204 No Content**
- Тело ответа отсутствует (пустое)

## 4. Обработка ошибок

Если на любом этапе возникает ошибка:
- Ошибка передается в `next(error)`
- Обрабатывается через `errorApiMiddlewares`
- Возвращается соответствующий HTTP статус и код ошибки

### Возможные ошибки:
- **404** (код 6): Person activation link not exist - возникает, если:
  - Активационная ссылка не найдена в БД
  - Ссылка уже была использована (очищена при предыдущей активации)
  - Ссылка неверна или истекла

## 5. Особенности реализации

### 5.1. Одноразовость активационной ссылки
- После успешной активации `activation_link` очищается (устанавливается в пустую строку)
- Это делает ссылку одноразовой - повторное использование невозможно
- Если пользователь попытается использовать ссылку повторно, получит ошибку 404

### 5.2. Отсутствие аутентификации
- Endpoint не требует аутентификации
- Это позволяет пользователю активировать аккаунт, перейдя по ссылке из email
- Не требуется наличие Access Token или Refresh Token

### 5.3. Простота реализации
- Минимальная логика: найти пользователя по ссылке и обновить статус
- Не создаются сессии, не генерируются токены
- После активации пользователь может войти в систему через `/api/login`

### 5.4. Формат активационной ссылки
- Ссылка представляет собой UUID v4 (например: `550e8400-e29b-41d4-a716-446655440000`)
- UUID генерируется при регистрации через `uuid.v4()` в методе `Person.createNewPerson()`
- Ссылка отправляется пользователю в email при регистрации

## 6. Связь с регистрацией

Активационная ссылка создается во время регистрации:
1. При регистрации (`POST /api/registration`) генерируется `activation_link` (UUID)
2. Ссылка сохраняется в БД вместе с данными пользователя
3. Email с активационной ссылкой отправляется пользователю (должно выполняться, но не реализовано в коде)
4. Пользователь переходит по ссылке `GET /api/activate/:link`
5. Аккаунт активируется, ссылка очищается

## Итоговая последовательность:

1. GET запрос → `/api/activate/:link` (где `:link` - UUID активационной ссылки)
2. Контроллер: Извлечение `link` из параметров пути
3. Поиск пользователя в БД по `activation_link`
4. Проверка существования пользователя (если не найден → 404)
5. Активация аккаунта: установка `is_activated = true`
6. Очистка активационной ссылки: установка `activation_link = ''`
7. Обновление пользователя в PostgreSQL
8. Возврат 204 No Content

## Сценарии использования:

### Сценарий 1: Успешная активация
- Активационная ссылка валидна и существует в БД
- Пользователь найден
- `is_activated` установлен в `true`
- `activation_link` очищен
- Пользователь обновлен в БД
- Возвращается 204 No Content

### Сценарий 2: Ссылка не найдена
- Активационная ссылка отсутствует в БД
- Возвращается 404 (код 6) с сообщением "Person activation link not exist"
- Возможные причины:
  - Ссылка неверна (опечатка в URL)
  - Ссылка уже была использована
  - Пользователь был удален

### Сценарий 3: Повторная активация
- Пользователь пытается активировать уже активированный аккаунт
- Поскольку `activation_link` был очищен при первой активации, поиск не найдет пользователя
- Возвращается 404 (код 6) с сообщением "Person activation link not exist"

## 7. Безопасность

### 7.1. Защита от перебора
- UUID v4 имеет очень большую энтропию (2^122 возможных значений)
- Практически невозможно угадать валидную активационную ссылку
- Даже при знании email пользователя, без знания UUID активация невозможна

### 7.2. Одноразовость
- После использования ссылка становится недействительной
- Это предотвращает повторную активацию и злоупотребление ссылкой

### 7.3. Отсутствие чувствительных данных
- Endpoint не возвращает информацию о пользователе
- Даже при неверной ссылке не раскрывается, существует ли пользователь с таким email
- Это предотвращает перебор email-адресов

## 8. Рекомендации по использованию

### 8.1. Email отправка
- Активационная ссылка должна отправляться пользователю в email при регистрации
- Формат ссылки: `{CLIENT_URL}/api/activate/{activation_link}`
- Email должен содержать инструкции по активации

### 8.2. Обработка на клиенте
- После успешной активации (204) клиент может перенаправить пользователя на страницу входа
- При ошибке 404 можно показать сообщение о неверной или истекшей ссылке

### 8.3. Время жизни ссылки
- В текущей реализации нет ограничения по времени жизни ссылки
- Рекомендуется добавить проверку времени создания аккаунта и ограничить срок действия ссылки (например, 24-48 часов)
